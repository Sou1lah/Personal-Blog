<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Personal Blog</title>
  <!-- IBM Plex Mono for the retro look -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <h1 class="site-title">My Blog</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
      <button id="reloadBtn" style="padding: 8px 16px; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50px; font-weight: 700; font-size: 14px; cursor: pointer; transition: all 0.2s ease; font-family: 'IBM Plex Mono', monospace;" aria-label="Toggle Notes">Notes</button>
      <a class="github-link" href="https://github.com/Sou1lah" target="_blank" rel="noopener noreferrer" aria-label="View GitHub profile">
        <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82A7.6 7.6 0 018 4.6c.68.003 1.36.092 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
      </a>
    </div>
  </header>

  <main class="container">
    <div id="blogSection" style="display: none;">
      <h2 style="font-size: 1.5rem; margin: 0 0 20px 0;">Blog Posts</h2>
      <p style="text-align: center; padding: 40px; color: rgba(36, 34, 27, 0.7);">Click "Notes" to view your notes from the wiki folder.</p>
    </div>

    <div id="notesSection" style="display: block;">
      <div id="notesCardsContainer" class="cards" aria-label="Notes content"></div>
    </div>

  </main>

  <footer class="site-footer container">
    <p>Â© 2026 My Blog</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="filter.js"></script>
  <script type="module" src="script.js"></script>

  <script>
    const GITHUB_API = 'https://api.github.com/repos/Sou1lah/Personal-Blog/contents/wiki';
    const GITHUB_RAW = 'https://raw.githubusercontent.com/Sou1lah/Personal-Blog/main/wiki';

    const reloadBtn = document.getElementById('reloadBtn');
    const blogSection = document.getElementById('blogSection');
    const notesSection = document.getElementById('notesSection');
    const notesCardsContainer = document.getElementById('notesCardsContainer');

    let isNotesMode = true;

    // Load notes on page load
    loadNotesContent();

    reloadBtn.addEventListener('click', async () => {
      isNotesMode = !isNotesMode;
      
      if (isNotesMode) {
        blogSection.style.display = 'none';
        notesSection.style.display = 'block';
        reloadBtn.textContent = 'Blog';
        await loadNotesContent();
      } else {
        blogSection.style.display = 'block';
        notesSection.style.display = 'none';
        reloadBtn.textContent = 'Notes';
      }
    });

    async function loadNotesContent() {
      notesCardsContainer.innerHTML = '<p style="text-align: center; padding: 40px; font-size: 1.1rem; color: rgba(36, 34, 27, 0.7);">Loading notes...</p>';
      
      try {
        const response = await fetch(GITHUB_API, {
          headers: { 'Accept': 'application/vnd.github.v3+json' }
        });

        if (!response.ok) {
          throw new Error(`Failed to fetch notes`);
        }

        const files = await response.json();
        const categories = {};

        for (const item of files) {
          if (item.type === 'dir') {
            const subResponse = await fetch(`${GITHUB_API}/${item.name}`, {
              headers: { 'Accept': 'application/vnd.github.v3+json' }
            });
            if (subResponse.ok) {
              const subFiles = await subResponse.json();
              categories[item.name] = subFiles.filter(f => f.name.endsWith('.md'));
            }
          } else if (item.name.endsWith('.md')) {
            if (!categories['Root']) categories['Root'] = [];
            categories['Root'].push(item);
          }
        }

        const totalFiles = Object.values(categories).reduce((sum, arr) => sum + arr.length, 0);
        if (totalFiles === 0) {
          notesCardsContainer.innerHTML = `
            <div style="text-align: center; padding: 60px 20px;">
              <p style="font-size: 1.1rem; color: rgba(36, 34, 27, 0.7); margin-bottom: 20px;">No notes found in wiki/ folder</p>
              <button onclick="location.reload()" style="padding: 10px 20px; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50px; font-weight: 700; font-size: 14px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; transition: all 0.2s ease;">Try Again</button>
            </div>
          `;
          return;
        }

        let html = '';
        for (const [category, items] of Object.entries(categories)) {
          if (items.length === 0) continue;

          for (const file of items) {
            const title = file.name.replace('.md', '').replace(/_/g, ' ');
            const path = category === 'Root' ? `wiki/${file.name}` : `wiki/${category}/${file.name}`;
            const rawUrl = `${GITHUB_RAW}/${path}`;

            html += `
              <article class="card" style="display: flex; flex-direction: column;">
                <div class="note-banner" data-raw-url="${rawUrl}" style="width: 100%; height: 140px; background-color: #d4c5b9; background-size: cover; background-position: center; background-repeat: no-repeat; border-radius: 10px 10px 0 0;"></div>
                <h3 class="card-title" style="margin-top: 12px;">${title}</h3>
                <div class="note-content" data-raw-url="${rawUrl}" style="flex: 1; font-size: 0.85rem; line-height: 1.5; color: var(--brown); max-height: 200px; overflow: hidden; border-top: 2px solid rgba(36, 34, 27, 0.1); padding-top: 12px; margin-top: 12px;"></div>
                <a href="post.html?note=${encodeURIComponent(path)}" class="btn" style="margin-top: 12px; align-self: flex-end;">Read</a>
              </article>
            `;
          }
        }

        notesCardsContainer.innerHTML = html;

        const bannerElements = notesCardsContainer.querySelectorAll('.note-banner');
        const contentElements = notesCardsContainer.querySelectorAll('.note-content');
        
        for (let i = 0; i < contentElements.length; i++) {
          const element = contentElements[i];
          const bannerElement = bannerElements[i];
          const rawUrl = element.getAttribute('data-raw-url');
          try {
            const response = await fetch(rawUrl);
            if (response.ok) {
              const markdown = await response.text();
              
              // Extract frontmatter for banner
              const frontmatterRegex = /^---\n([\s\S]*?)\n---\n/;
              const match = markdown.match(frontmatterRegex);
              let content = markdown;
              
              if (match) {
                const frontmatter = match[1];
                const bannerMatch = frontmatter.match(/banner:\s*(.+)/);
                if (bannerMatch) {
                  const bannerUrl = bannerMatch[1].trim().replace(/['"]/g, '');
                  console.log('Setting banner:', bannerUrl);
                  bannerElement.style.backgroundImage = `url("${bannerUrl}")`;
                  bannerElement.style.backgroundColor = 'transparent';
                } else {
                  // Placeholder if no banner found - use gradient
                  bannerElement.style.backgroundImage = 'linear-gradient(135deg, #d4c5b9 0%, #a89f99 100%)';
                  bannerElement.style.backgroundColor = '#d4c5b9';
                }
                content = markdown.replace(frontmatterRegex, '');
              } else {
                // Placeholder if no frontmatter found
                bannerElement.style.backgroundImage = 'linear-gradient(135deg, #d4c5b9 0%, #a89f99 100%)';
                bannerElement.style.backgroundColor = '#d4c5b9';
              }
              
              const html = marked.parse(content);
              const tempDiv = document.createElement('div');
              tempDiv.innerHTML = html;
              const textContent = tempDiv.textContent || tempDiv.innerText;
              element.textContent = textContent.substring(0, 300) + (textContent.length > 300 ? '...' : '');
            }
          } catch (error) {
            console.error('Error loading content:', error);
            element.textContent = 'Error loading content';
          }
        }
      } catch (error) {
        console.error('Error fetching notes:', error);
        notesCardsContainer.innerHTML = `
          <div style="text-align: center; padding: 60px 20px;">
            <p style="font-size: 1.1rem; color: red; margin-bottom: 20px;">Error loading notes</p>
            <button onclick="location.reload()" style="padding: 10px 20px; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50px; font-weight: 700; font-size: 14px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; transition: all 0.2s ease;">Try Again</button>
          </div>
        `;
      }
    }
  </script>
</body>
</html>