<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Personal Blog</title>
  <!-- IBM Plex Mono for the retro look -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <h1 class="site-title">My Blog</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
      <button id="reloadBtn" style="width:40px; height:40px; padding:0; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50%; font-weight: 700; font-size: 16px; cursor: pointer; transition: transform 0.6s ease; font-family: 'IBM Plex Mono', monospace; display: inline-flex; align-items: center; justify-content: center;" aria-label="Reload notes" title="Reload notes">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0114.13-3.36L23 10"></path><path d="M20.49 15a9 9 0 01-14.13 3.36L1 14"></path></svg>
      </button>
      <a class="github-link" href="https://github.com/Sou1lah" target="_blank" rel="noopener noreferrer" aria-label="View GitHub profile">
        <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82A7.6 7.6 0 018 4.6c.68.003 1.36.092 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
      </a>
    </div>
  </header>

  <main class="container">
    <div id="blogSection" style="display: none;">
      <h2 style="font-size: 1.5rem; margin: 0 0 20px 0;">Blog Posts</h2>
      <p style="text-align: center; padding: 40px; color: rgba(36, 34, 27, 0.7);">Click "Notes" to view your notes from the wiki folder.</p>
    </div>

    <div id="notesSection" style="display: block;">
      <div id="notesCardsContainer" class="cards" aria-label="Notes content"></div>
    </div>

  </main>

  <footer class="site-footer container">
    <p>Â© 2026 My Blog</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="filter.js"></script>
  <script type="module" src="script.js"></script>

  <script>
    const GITHUB_API = 'https://api.github.com/repos/Sou1lah/Personal-Blog/contents/wiki';
    const GITHUB_RAW = 'https://raw.githubusercontent.com/Sou1lah/Personal-Blog/main/wiki';

    const reloadBtn = document.getElementById('reloadBtn');
    const blogSection = document.getElementById('blogSection');
    const notesSection = document.getElementById('notesSection');
    const notesCardsContainer = document.getElementById('notesCardsContainer');

    let isNotesMode = true;

    // Load notes on page load
    loadNotesContent();

    reloadBtn.addEventListener('click', async () => {
      // Reload notes from wiki
      try {
        reloadBtn.disabled = true;
        reloadBtn.style.transform = 'rotate(360deg)';
        // Disable theme toggle while fetching to avoid visual flicker or race conditions
        if (window.setThemeToggleEnabled) window.setThemeToggleEnabled(false);
        await loadNotesContent();
      } finally {
        reloadBtn.style.transform = '';
        reloadBtn.disabled = false;
        if (window.setThemeToggleEnabled) window.setThemeToggleEnabled(true);
      }
    });

    async function loadNotesContent() {
      notesCardsContainer.innerHTML = '<p style="text-align: center; padding: 40px; font-size: 1.1rem; color: rgba(36, 34, 27, 0.7);">Loading notes...</p>';
      
      try {
        let files = null;
        try {
          const response = await fetch(GITHUB_API, {
            headers: { 'Accept': 'application/vnd.github.v3+json' }
          });

          if (!response.ok) throw new Error('Failed to fetch notes');
          files = await response.json();
        } catch (githubErr) {
          console.warn('GitHub API failed, attempting local /wiki fallback:', githubErr);
          // Try to read the local /wiki/ directory listing (served by local dev server)
          try {
            const localResp = await fetch('/wiki/');
            if (!localResp.ok) throw new Error('Local /wiki/ not accessible');
            const html = await localResp.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            let anchors = Array.from(doc.querySelectorAll('a'))
              .map(a => a.getAttribute('href'))
              .filter(h => h && h.endsWith('.md'));

            // If no anchors found, try common subdirectories (useful for local servers that serve folder listings per-subdir)
            if (anchors.length === 0) {
              console.warn('No markdown links found at /wiki/, trying common subdirectories...');
              const commonDirs = ['animals', 'Mythical'];
              for (const dir of commonDirs) {
                try {
                  const subResp = await fetch(`/wiki/${dir}/`);
                  if (!subResp.ok) continue;
                  const subHtml = await subResp.text();
                  const subDoc = parser.parseFromString(subHtml, 'text/html');
                  const subAnchors = Array.from(subDoc.querySelectorAll('a'))
                    .map(a => a.getAttribute('href'))
                    .filter(h => h && h.endsWith('.md'))
                    .map(h => (h.startsWith('/') ? h.replace(/^\//, '') : `${dir}/${h}`));
                  if (subAnchors.length) anchors = anchors.concat(subAnchors);
                } catch (e) {
                  console.warn('Failed to fetch subdir /wiki/' + dir + '/', e);
                }
              }
            }

            console.log('Local anchors:', anchors);

            // Normalize and build categories directly from anchors to avoid GitHub API structure
            const localCategories = {};
            anchors.forEach(href => {
              let cleaned = decodeURIComponent(href).replace(/^\/?/, '').trim().replace(/\s+\.md$/, '.md');
              // Remove a leading 'wiki/' segment if present (links may include it)
              if (cleaned.toLowerCase().startsWith('wiki/')) cleaned = cleaned.replace(/^wiki\//i, '');
              const parts = cleaned.split('/');
              if (parts.length === 1) {
                if (!localCategories['Root']) localCategories['Root'] = [];
                localCategories['Root'].push({ name: parts[0], path: cleaned, download_url: `/wiki/${cleaned}` });
              } else {
                const dir = parts[0];
                const filename = parts.slice(1).join('/');
                if (!localCategories[dir]) localCategories[dir] = [];
                localCategories[dir].push({ name: filename, path: cleaned, download_url: `/wiki/${cleaned}` });
              }
            });

            console.log('Built localCategories:', localCategories);
            // assign categories directly and flag to skip GitHub parsing
            files = null; // signal that we used local categories
            var usedLocalCategories = true;
            var categoriesFromLocal = localCategories;

            // If we didn't use local categories, turn files array into a pseudo-API structure
            if (typeof usedLocalCategories === 'undefined' || !usedLocalCategories) {
              const grouped = {};
              for (const f of files) {
                const parts = f.path.split('/');
                if (parts.length === 1) {
                  if (!grouped['Root']) grouped['Root'] = [];
                  grouped['Root'].push({ name: f.name, path: f.path, download_url: f.url });
                } else {
                  const dir = parts[0];
                  if (!grouped[dir]) grouped[dir] = [];
                  grouped[dir].push({ name: parts.slice(1).join('/'), path: f.path, download_url: f.url });
                }
              }

              // Convert grouped back to a files-like array for the rest of the code path
              const pseudoFiles = [];
              for (const [dir, items] of Object.entries(grouped)) {
                if (dir === 'Root') {
                  for (const it of items) pseudoFiles.push({ name: it.name, download_url: it.url });
                } else {
                  pseudoFiles.push({ name: dir, type: 'dir', _localFiles: items });
                }
              }

              // Replace files with this pseudo structure
              files = pseudoFiles;
            } else {
              // we already built categoriesFromLocal earlier and will use it directly
            }
          } catch (localErr) {
            console.error('Local /wiki fallback failed:', localErr);
            throw githubErr; // rethrow original GitHub error to be handled below
          }
        }
        let categories = {};

        if (typeof usedLocalCategories !== 'undefined' && usedLocalCategories) {
          categories = categoriesFromLocal;
        } else {
          for (const item of files) {
            if (item.type === 'dir') {
              const subResponse = await fetch(`${GITHUB_API}/${item.name}`, {
                headers: { 'Accept': 'application/vnd.github.v3+json' }
              });
              if (subResponse.ok) {
                const subFiles = await subResponse.json();
                categories[item.name] = subFiles.filter(f => f.name.endsWith('.md'));
              }
            } else if (item.name.endsWith('.md')) {
              if (!categories['Root']) categories['Root'] = [];
              categories['Root'].push(item);
            }
          }
        }

        const totalFiles = Object.values(categories).reduce((sum, arr) => sum + arr.length, 0);
        if (totalFiles === 0) {
          notesCardsContainer.innerHTML = `
            <div style="min-height: calc(50vh); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:20px; padding: 20px; width:100%; text-align:center;">
              <p style="font-size: 1.4rem; color: rgba(36, 34, 27, 0.9); margin: 0;">No notes found in wiki/ folder</p>
              <button onclick="location.reload()" style="padding: 10px 20px; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50px; font-weight: 700; font-size: 14px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; transition: all 0.2s ease;">Try Again</button>
            </div>
          `;
          return;
        }

        let html = '';
        for (const [category, items] of Object.entries(categories)) {
          if (items.length === 0) continue;

          for (const file of items) {
            const title = file.name.replace('.md', '').replace(/_/g, ' ');
            // Remove duplicated wiki/ if present
            let path = category === 'Root' ? `wiki/${file.name}` : `wiki/${category}/${file.name}`;
            if (path.startsWith('wiki/wiki/')) {
              path = path.replace('wiki/wiki/', 'wiki/');
            }
            // Encode each path segment to handle spaces and special characters
            let rawUrl;
            if (typeof usedLocalCategories !== 'undefined' && usedLocalCategories) {
              rawUrl = `/${path.split('/').map(encodeURIComponent).join('/')}`; // local path on dev server
            } else {
              rawUrl = `${GITHUB_RAW}/${path.split('/').map(encodeURIComponent).join('/')}`; // GitHub raw
            }
            // Extra fallback: if rawUrl contains 'wiki/wiki/', replace with 'wiki/'
            if (rawUrl.includes('wiki/wiki/')) {
              rawUrl = rawUrl.replace('wiki/wiki/', 'wiki/');
            }
            console.log('Raw note URL:', rawUrl);

            html += `
              <article class="card" style="display: flex; flex-direction: column; min-height: 260px;">
                <div class="note-banner" data-raw-url="${rawUrl}" style="width: 100%; height: 140px; background-color: #d4c5b9; background-size: cover; background-position: center; background-repeat: no-repeat; border-radius: 10px 10px 0 0;"></div>
                <h3 class="card-title" style="margin-top: 12px;">${title}</h3>
                <div style="flex: 1;"></div>
                <a href="post.html?note=${encodeURIComponent(path)}" class="btn" style="margin-top: 12px; align-self: flex-end;">Read</a>
              </article>
            `;
          }
        }

        notesCardsContainer.innerHTML = html;

        const bannerElements = notesCardsContainer.querySelectorAll('.note-banner');

        // For card thumbnails we only need to set banners; skip content previews
        for (let i = 0; i < bannerElements.length; i++) {
          const bannerElement = bannerElements[i];
          const rawUrl = bannerElement.getAttribute('data-raw-url');
          try {
            const r = await fetch(rawUrl);
            if (!r.ok) throw new Error('Failed to fetch markdown: ' + rawUrl);
            const md = await r.text();
            const fm = md.match(/^---\n([\s\S]*?)\n---\n/);
            let bannerUrl = null;
            if (fm) {
              const bannerMatch = fm[1].match(/banner:\s*(.+)/);
              if (bannerMatch) {
                bannerUrl = bannerMatch[1].trim().replace(/^['"]|['"]$/g, '');
                // Use bannerUrl directly if it's absolute
                if (bannerUrl.startsWith('http')) {
                  // do nothing, use as is
                } else if (bannerUrl.startsWith('/wiki/')) {
                  bannerUrl = bannerUrl.replace('/wiki/', `${GITHUB_RAW}/`);
                }
              }
            }
            if (bannerUrl) {
              bannerElement.style.backgroundImage = `url('${bannerUrl}')`;
              bannerElement.style.backgroundColor = 'transparent';
              bannerElement.style.backgroundSize = 'cover';
              bannerElement.style.backgroundPosition = 'center';
              bannerElement.style.backgroundRepeat = 'no-repeat';
            } else {
              // Try to fetch banner again with fallback rawUrl
              let fallbackRawUrl = rawUrl.replace('wiki/wiki/', 'wiki/');
              if (fallbackRawUrl !== rawUrl) {
                try {
                  const fallbackR = await fetch(fallbackRawUrl);
                  if (fallbackR.ok) {
                    const fallbackMd = await fallbackR.text();
                    const fallbackFm = fallbackMd.match(/^---\n([\s\S]*?)\n---\n/);
                    if (fallbackFm) {
                      const fallbackBannerMatch = fallbackFm[1].match(/banner:\s*(.+)/);
                      if (fallbackBannerMatch) {
                        bannerUrl = fallbackBannerMatch[1].trim().replace(/^['"]|['"]$/g, '');
                        if (bannerUrl.startsWith('http')) {
                          // do nothing
                        } else if (bannerUrl.startsWith('/wiki/')) {
                          bannerUrl = bannerUrl.replace('/wiki/', `${GITHUB_RAW}/`);
                        }
                        bannerElement.style.backgroundImage = `url('${bannerUrl}')`;
                        bannerElement.style.backgroundColor = 'transparent';
                        bannerElement.style.backgroundSize = 'cover';
                        bannerElement.style.backgroundPosition = 'center';
                        bannerElement.style.backgroundRepeat = 'no-repeat';
                        continue;
                      }
                    }
                  }
                } catch (fallbackErr) {
                  console.error('Fallback fetch failed:', fallbackErr);
                }
              }
              bannerElement.style.backgroundImage = `url("https://raw.githubusercontent.com/Sou1lah/Personal-Blog/main/assets/ImagePlaceholder.jpg")`;
              bannerElement.style.backgroundColor = '#e8e8e8';
              bannerElement.style.backgroundSize = 'cover';
              bannerElement.style.backgroundPosition = 'center';
              bannerElement.style.backgroundRepeat = 'no-repeat';
            }
          } catch (e) {
            console.error('Banner fetch error:', e);
            bannerElement.style.backgroundImage = `url("https://raw.githubusercontent.com/Sou1lah/Personal-Blog/main/assets/ImagePlaceholder.jpg")`;
            bannerElement.style.backgroundColor = '#e8e8e8';
            bannerElement.style.backgroundSize = 'cover';
            bannerElement.style.backgroundPosition = 'center';
            bannerElement.style.backgroundRepeat = 'no-repeat';
          }
        }
      } catch (error) {
        console.error('Error fetching notes:', error);
        notesCardsContainer.innerHTML = `
          <div style="min-height: calc(50vh); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:20px; padding: 20px; width:100%; text-align:center;">
            <p style="font-size: 1.4rem; color: red; margin: 0;">Error loading notes</p>
            <button onclick="location.reload()" style="padding: 10px 20px; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50px; font-weight: 700; font-size: 14px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; transition: all 0.2s ease;">Try Again</button>
          </div>
        `;
      }
    }
  </script>
</body>
</html>