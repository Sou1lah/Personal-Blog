<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Personal Blog</title>
  <!-- IBM Plex Mono for the retro look -->
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header">
    <h1 class="site-title">My Blog</h1>
    <div style="display: flex; gap: 10px; align-items: center;">
      <button id="reloadBtn" style="width:40px; height:40px; padding:0; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50%; font-weight: 700; font-size: 16px; cursor: pointer; transition: transform 0.6s ease; font-family: 'IBM Plex Mono', monospace; display: inline-flex; align-items: center; justify-content: center;" aria-label="Reload notes" title="Reload notes">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0114.13-3.36L23 10"></path><path d="M20.49 15a9 9 0 01-14.13 3.36L1 14"></path></svg>
      </button>
      <a class="github-link" href="https://github.com/Sou1lah" target="_blank" rel="noopener noreferrer" aria-label="View GitHub profile">
        <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
          <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82A7.6 7.6 0 018 4.6c.68.003 1.36.092 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
        </svg>
      </a>
    </div>
  </header>

  <main class="container">
    <div id="blogSection" style="display: none;">
      <h2 style="font-size: 1.5rem; margin: 0 0 20px 0;">Blog Posts</h2>
      <p style="text-align: center; padding: 40px; color: rgba(36, 34, 27, 0.7);">Click "Notes" to view your notes from the wiki folder.</p>
    </div>

    <div id="notesSection" style="display: block;">
      <div id="notesCardsContainer" class="cards" aria-label="Notes content"></div>
    </div>

  </main>

  <footer class="site-footer container">
    <p>Â© 2026 My Blog</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="filter.js"></script>
  <script type="module" src="script.js"></script>

  <script>
    const GITHUB_API = 'https://api.github.com/repos/Sou1lah/Personal-Blog/contents/wiki';
    const GITHUB_RAW = 'https://raw.githubusercontent.com/Sou1lah/Personal-Blog/main/wiki';

    const reloadBtn = document.getElementById('reloadBtn');
    const blogSection = document.getElementById('blogSection');
    const notesSection = document.getElementById('notesSection');
    const notesCardsContainer = document.getElementById('notesCardsContainer');

    let isNotesMode = true;

    // Load notes on page load
    loadNotesContent();

    reloadBtn.addEventListener('click', async () => {
      // Reload notes from wiki (force fetch and update cache)
      try {
        reloadBtn.disabled = true;
        reloadBtn.style.transform = 'rotate(360deg)';
        if (window.setThemeToggleEnabled) window.setThemeToggleEnabled(false);
        await loadNotesContent(true); // force fetch
      } finally {
        reloadBtn.style.transform = '';
        reloadBtn.disabled = false;
        if (window.setThemeToggleEnabled) window.setThemeToggleEnabled(true);
      }
    });

    async function loadNotesContent(forceFetch = false) {
      notesCardsContainer.innerHTML = '<p style="text-align: center; padding: 40px; font-size: 1.1rem; color: rgba(36, 34, 27, 0.7);">Loading notes...</p>';

      try {
        // Use localStorage cache unless forceFetch is true
      let categories = {};
      if (!forceFetch) {
        const cached = localStorage.getItem('wikiNotesCache');
        if (cached) {
          try {
            categories = JSON.parse(cached);
          } catch (e) {
            categories = {};
          }
        }
      }
      if (Object.keys(categories).length === 0 || forceFetch) {
        // Helper: recursively fetch all .md files from GitHub API
        async function fetchAllMarkdownFiles(apiUrl, category = null) {
          const result = {};
          const response = await fetch(apiUrl, { headers: { 'Accept': 'application/vnd.github.v3+json' } });
          if (!response.ok) return result;
          const items = await response.json();
          for (const item of items) {
            if (item.type === 'dir') {
              const sub = await fetchAllMarkdownFiles(`${apiUrl}/${item.name}`, item.name);
              for (const [cat, files] of Object.entries(sub)) {
                if (!result[cat]) result[cat] = [];
                result[cat] = result[cat].concat(files);
              }
            } else if (item.name.endsWith('.md')) {
              const cat = category || 'Root';
              if (!result[cat]) result[cat] = [];
              result[cat].push(item);
            }
          }
          return result;
        }
        // Helper: recursively fetch all .md files from local server
        async function fetchAllMarkdownFilesLocal(basePath = '/wiki/', category = null) {
          const result = {};
          const resp = await fetch(basePath);
          if (!resp.ok) return result;
          const html = await resp.text();
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const anchors = Array.from(doc.querySelectorAll('a'));
          for (const a of anchors) {
            const href = a.getAttribute('href');
            if (!href || href === '../') continue;
            if (href.endsWith('.md')) {
              let cleaned = decodeURIComponent(href).replace(/^\/?/, '').trim().replace(/\s+\.md$/, '.md');
              if (cleaned.toLowerCase().startsWith('wiki/')) cleaned = cleaned.replace(/^wiki\//i, '');
              const parts = cleaned.split('/');
              const cat = category || (parts.length > 1 ? parts[0] : 'Root');
              if (!result[cat]) result[cat] = [];
              result[cat].push({ name: parts.slice(-1)[0], path: cleaned, download_url: `/wiki/${cleaned}` });
            } else if (!href.endsWith('.md') && !href.includes('.')) {
              // Likely a subdirectory
              const sub = await fetchAllMarkdownFilesLocal(basePath + href, href.replace(/\/$/, ''));
              for (const [cat, files] of Object.entries(sub)) {
                if (!result[cat]) result[cat] = [];
                result[cat] = result[cat].concat(files);
              }
            }
          }
          return result;
        }
        try {
          // Try index.json manifest first (local dev or GitHub raw)
          let indexList = null;
          try {
            const idxResp = await fetch('/wiki/index.json');
            if (idxResp.ok) indexList = await idxResp.json();
          } catch (e) {}
          if (!indexList) {
            try {
              const ghIdxResp = await fetch(`${GITHUB_RAW}/index.json`);
              if (ghIdxResp.ok) indexList = await ghIdxResp.json();
            } catch (e) {}
          }

          if (indexList && Array.isArray(indexList.files) && indexList.files.length) {
            const built = {};
            for (const p of indexList.files) {
              const cleaned = decodeURIComponent(p).replace(/^\/?/, '').trim();
              const parts = cleaned.split('/');
              if (parts.length === 1) {
                if (!built['Root']) built['Root'] = [];
                built['Root'].push({ name: parts[0], path: cleaned, download_url: `/wiki/${cleaned}` });
              } else {
                const dir = parts[0];
                const filename = parts.slice(1).join('/');
                if (!built[dir]) built[dir] = [];
                built[dir].push({ name: filename, path: cleaned, download_url: `/wiki/${cleaned}` });
              }
            }
            categories = built;
            try { localStorage.setItem('wikiNotesCache', JSON.stringify(categories)); } catch (e) {}
          } else {
            try {
              categories = await fetchAllMarkdownFiles(GITHUB_API);
            } catch (githubErr) {
              console.warn('GitHub API failed, attempting local /wiki fallback:', githubErr);
              try {
                categories = await fetchAllMarkdownFilesLocal();
              } catch (localErr) {
                console.error('Local /wiki fallback failed:', localErr);
                throw githubErr;
              }
            }
            try { localStorage.setItem('wikiNotesCache', JSON.stringify(categories)); } catch (e) {}
          }
        } catch (e) {
          // If all fetching fails, categories remains empty and error will be handled below
        }
      }

        const totalFiles = Object.values(categories).reduce((sum, arr) => sum + arr.length, 0);
        if (totalFiles === 0) {
          notesCardsContainer.innerHTML = `
            <div style="min-height: calc(50vh); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:20px; padding: 20px; width:100%; text-align:center;">
              <p style="font-size: 1.4rem; color: rgba(36, 34, 27, 0.9); margin: 0;">No notes found in wiki/ folder</p>
              <button onclick="location.reload()" style="padding: 10px 20px; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50px; font-weight: 700; font-size: 14px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; transition: all 0.2s ease;">Try Again</button>
            </div>
          `;
          return;
        }

        let html = '';
        for (const [category, items] of Object.entries(categories)) {
          if (items.length === 0) continue;

          for (const file of items) {
            const title = file.name.replace('.md', '').replace(/_/g, ' ');
            // Remove duplicated wiki/ if present
            let path = category === 'Root' ? `wiki/${file.name}` : `wiki/${category}/${file.name}`;
            if (path.startsWith('wiki/wiki/')) {
              path = path.replace('wiki/wiki/', 'wiki/');
            }
            // Use file.download_url if present and starts with / (local), else build GitHub raw URL
            let rawUrl;
            if (file.download_url && file.download_url.startsWith('/wiki/')) {
              rawUrl = file.download_url;
            } else {
              rawUrl = `${GITHUB_RAW}/${path.split('/').map(encodeURIComponent).join('/')}`;
            }
            if (rawUrl.includes('wiki/wiki/')) {
              rawUrl = rawUrl.replace('wiki/wiki/', 'wiki/');
            }
            console.log('Raw note URL:', rawUrl);

            // Synchronously add a placeholder for tags, to be filled after fetch
            const cardId = `card-${category.replace(/[^a-zA-Z0-9]/g, '')}-${file.name.replace(/[^a-zA-Z0-9]/g, '')}`;
            html += `
              <article class="card" id="${cardId}" style="display: flex; flex-direction: column; min-height: 260px; position: relative;">
                <div class="note-banner" data-raw-url="${rawUrl}" style="width: 100%; height: 140px; background-color: #d4c5b9; background-size: cover; background-position: center; background-repeat: no-repeat; border-radius: 10px 10px 0 0;"></div>
                <h3 class="card-title" style="margin-top: 12px;">${title}</h3>
                <div style="flex: 1;"></div>
                <div class="note-tags-scroll-wrap" style="position: absolute; left: 16px; right: 110px; bottom: 18px; z-index: 2; pointer-events: auto; max-width: calc(100% - 130px);">
                  <div class="note-tags" style="display: flex; flex-wrap: nowrap; gap: 6px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; padding-bottom: 2px; -webkit-overflow-scrolling: touch; max-width: 100%; position: relative;"></div>
                  <div class="tags-fade" style="position: absolute; right: 0; top: 0; width: 40px; height: 100%; pointer-events: none; background: linear-gradient(to right, transparent, var(--cream, #f5f0e6) 80%);"></div>
                </div>
                <style>
                  .note-tags::-webkit-scrollbar {
                    display: none;
                  }
                  .note-tags {
                    scrollbar-width: none;
                    -ms-overflow-style: none;
                  }
                  .tags-fade.hidden { display: none !important; }
                </style>
                <a href="post.html?note=${encodeURIComponent(path)}" class="btn" style="margin-top: 12px; align-self: flex-end;">Read</a>
              </article>
            `;
          }
        }

        notesCardsContainer.innerHTML = html;

        const bannerElements = notesCardsContainer.querySelectorAll('.note-banner');

        // For card thumbnails we only need to set banners; skip content previews
        for (let i = 0; i < bannerElements.length; i++) {
          const bannerElement = bannerElements[i];
          const rawUrl = bannerElement.getAttribute('data-raw-url');
          try {
            const r = await fetch(rawUrl);
            if (!r.ok) throw new Error('Failed to fetch markdown: ' + rawUrl);
            const md = await r.text();
            const fm = md.match(/^---\n([\s\S]*?)\n---\n/);
            let bannerUrl = null;
            let tags = [];
            if (fm) {
              const bannerMatch = fm[1].match(/banner:\s*(.+)/);
              if (bannerMatch) {
                bannerUrl = bannerMatch[1].trim().replace(/^['"]|['"]$/g, '');
                if (bannerUrl.startsWith('http')) {
                  // do nothing, use as is
                } else if (bannerUrl.startsWith('/wiki/')) {
                  bannerUrl = bannerUrl.replace('/wiki/', `${GITHUB_RAW}/`);
                }
              }
              // Parse YAML array tags
              const tagsMatch = fm[1].match(/tags\s*:\s*\n([\s\S]*?)(\n\w|\ncssclasses:|$)/);
              if (tagsMatch) {
                tags = tagsMatch[1].split('\n').map(t => t.replace(/^-\s*/, '').trim()).filter(Boolean);
              }
              // Parse inline tags (e.g. tags: #tag1 #tag2 or tags: tag1, tag2)
              const tagsInline = fm[1].match(/tags\s*:?\s*([^\n]+)/);
              if (tagsInline) {
                // Extract hashtags and/or comma/space separated tags
                const inline = tagsInline[1];
                // Find all #hashtags
                const hashTags = Array.from(inline.matchAll(/#(\w[\w-]*)/g)).map(m => m[1]);
                // Find comma-separated tags
                const commaTags = inline.split(',').map(t => t.trim()).filter(t => t && !t.startsWith('#'));
                // Find space-separated tags (if not comma-separated)
                let spaceTags = [];
                if (!inline.includes(',')) {
                  spaceTags = inline.split(/\s+/).map(t => t.replace(/^#/, '').trim()).filter(t => t && t !== '');
                }
                tags = tags.concat(hashTags, commaTags, spaceTags);
              }
              // Deduplicate tags
              tags = Array.from(new Set(tags.map(t => t.replace(/^#/, '').trim()).filter(Boolean)));
            }
            if (bannerUrl) {
              bannerElement.style.backgroundImage = `url('${bannerUrl}')`;
              bannerElement.style.backgroundColor = 'transparent';
              bannerElement.style.backgroundSize = 'cover';
              bannerElement.style.backgroundPosition = 'center';
              bannerElement.style.backgroundRepeat = 'no-repeat';
            } else {
              // Try to fetch banner again with fallback rawUrl
              let fallbackRawUrl = rawUrl.replace('wiki/wiki/', 'wiki/');
              if (fallbackRawUrl !== rawUrl) {
                try {
                  const fallbackR = await fetch(fallbackRawUrl);
                  if (fallbackR.ok) {
                    const fallbackMd = await fallbackR.text();
                    const fallbackFm = fallbackMd.match(/^---\n([\s\S]*?)\n---\n/);
                    if (fallbackFm) {
                      const fallbackBannerMatch = fallbackFm[1].match(/banner:\s*(.+)/);
                      if (fallbackBannerMatch) {
                        bannerUrl = fallbackBannerMatch[1].trim().replace(/^['"]|['"]$/g, '');
                        if (bannerUrl.startsWith('http')) {
                          // do nothing
                        } else if (bannerUrl.startsWith('/wiki/')) {
                          bannerUrl = bannerUrl.replace('/wiki/', `${GITHUB_RAW}/`);
                        }
                        bannerElement.style.backgroundImage = `url('${bannerUrl}')`;
                        bannerElement.style.backgroundColor = 'transparent';
                        bannerElement.style.backgroundSize = 'cover';
                        bannerElement.style.backgroundPosition = 'center';
                        bannerElement.style.backgroundRepeat = 'no-repeat';
                        continue;
                      }
                    }
                  }
                } catch (fallbackErr) {
                  console.error('Fallback fetch failed:', fallbackErr);
                }
              }
              bannerElement.style.backgroundImage = `url("https://raw.githubusercontent.com/Sou1lah/Personal-Blog/main/assets/ImagePlaceholder.jpg")`;
              bannerElement.style.backgroundColor = '#e8e8e8';
              bannerElement.style.backgroundSize = 'cover';
              bannerElement.style.backgroundPosition = 'center';
              bannerElement.style.backgroundRepeat = 'no-repeat';
            }
            // Render tags as badges
            const card = bannerElement.closest('.card');
            if (card && tags.length) {
              const tagsDiv = card.querySelector('.note-tags');
              const fadeDiv = card.querySelector('.tags-fade');
              // Social media icon map
              const socialIcons = {
                'youtube': {
                  svg: '<svg width="16" height="16" viewBox="0 0 24 24" fill="#fff" style="vertical-align:middle;"><rect width="24" height="24" rx="5" fill="#FF0000"/><path d="M10 15.5V8.5L16 12L10 15.5Z" fill="#fff"/></svg>',
                  bg: '#FF0000', color: '#fff'
                },
                'twitter': {
                  svg: '<svg width="16" height="16" viewBox="0 0 24 24" fill="#1DA1F2" style="vertical-align:middle;"><rect width="24" height="24" rx="5" fill="#1DA1F2"/><path d="M19.633 7.997c.013.176.013.353.013.53 0 5.39-4.104 11.61-11.61 11.61-2.307 0-4.453-.676-6.26-1.84.32.037.637.05.97.05 1.92 0 3.687-.65 5.096-1.747-1.8-.037-3.32-1.22-3.843-2.85.25.037.5.062.763.062.37 0 .74-.05 1.085-.144-1.87-.375-3.28-2.03-3.28-4.02v-.05c.55.306 1.18.49 1.85.513a4.07 4.07 0 01-1.81-3.39c0-.75.2-1.45.55-2.05a11.62 11.62 0 008.42 4.27c-.062-.3-.1-.6-.1-.92 0-2.22 1.8-4.02 4.02-4.02 1.16 0 2.21.49 2.95 1.28a7.94 7.94 0 002.56-.98c-.28.87-.87 1.6-1.65 2.06a8.07 8.07 0 002.31-.62c-.52.81-1.17 1.52-1.92 2.09z" fill="#fff"/></svg>',
                  bg: '#1DA1F2', color: '#fff'
                }
                // Add more social icons here as needed
              };
              function renderTag(tag) {
                const lower = tag.toLowerCase();
                if (socialIcons[lower]) {
                  const icon = socialIcons[lower];
                  return `<span style="display:inline-block;background:${icon.bg};color:${icon.color};font-size:0.85em;padding:2px 10px 2px 8px;border-radius:50px;box-shadow:0 1px 4px #0001;white-space:nowrap;vertical-align:middle;gap:4px;">${icon.svg}<span style='margin-left:6px;vertical-align:middle;'>${tag}</span></span>`;
                }
                return `<span style="display:inline-block;background:#f5f5f5;color:#444;font-size:0.85em;padding:2px 10px 2px 10px;border-radius:50px;box-shadow:0 1px 4px #0001;white-space:nowrap;">${tag}</span>`;
              }
              if (tagsDiv) {
                tagsDiv.innerHTML = tags.map(renderTag).join(' ');
              }
              // Hide fade at end of scroll
              if (tagsDiv && fadeDiv) {
                const updateFade = () => {
                  if (tagsDiv.scrollWidth - tagsDiv.scrollLeft > tagsDiv.clientWidth + 2) {
                    fadeDiv.classList.remove('hidden');
                  } else {
                    fadeDiv.classList.add('hidden');
                  }
                };
                tagsDiv.addEventListener('scroll', updateFade);
                setTimeout(updateFade, 10);
              }
            }
          } catch (e) {
            console.error('Banner fetch error:', e);
            bannerElement.style.backgroundImage = `url("https://raw.githubusercontent.com/Sou1lah/Personal-Blog/main/assets/ImagePlaceholder.jpg")`;
            bannerElement.style.backgroundColor = '#e8e8e8';
            bannerElement.style.backgroundSize = 'cover';
            bannerElement.style.backgroundPosition = 'center';
            bannerElement.style.backgroundRepeat = 'no-repeat';
          }
        }
      } catch (error) {
        console.error('Error fetching notes:', error);
        notesCardsContainer.innerHTML = `
          <div style="min-height: calc(50vh); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:20px; padding: 20px; width:100%; text-align:center;">
            <p style="font-size: 1.4rem; color: red; margin: 0;">Error loading notes</p>
            <button onclick="location.reload()" style="padding: 10px 20px; background: var(--brown); color: var(--cream); border: 3px solid var(--brown); border-radius: 50px; font-weight: 700; font-size: 14px; cursor: pointer; font-family: 'IBM Plex Mono', monospace; transition: all 0.2s ease;">Try Again</button>
          </div>
        `;
      }
    }
  </script>
</body>
</html>