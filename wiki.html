<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Wiki - Personal Blog</title>
  <link href="https://fonts.googleapis.com/css2?family=Buda:wght@300&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <style>
    .wiki-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 0;
      margin-bottom: 30px;
    }

    .wiki-header h1 {
      font-size: 2rem;
      margin: 0;
    }

    .back-to-home {
      display: inline-block;
      padding: 8px 16px;
      background: var(--brown);
      color: var(--cream);
      text-decoration: none;
      border-radius: 50px;
      border: 3px solid var(--brown);
      font-weight: 700;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .back-to-home:hover {
      background: var(--cream);
      color: var(--brown);
    }

    .wiki-card {
      background: white;
      border: 3px solid var(--brown);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      transition: all 0.2s ease;
    }

    .wiki-card:hover {
      box-shadow: 0 4px 12px rgba(36, 34, 27, 0.1);
      transform: translateY(-2px);
    }

    .wiki-card-title {
      font-size: 1.3rem;
      font-weight: 900;
      margin: 0 0 15px 0;
      color: var(--brown);
      border-bottom: 2px solid var(--brown);
      padding-bottom: 10px;
    }

    .wiki-card-content {
      font-size: 0.95rem;
      line-height: 1.6;
      color: var(--brown);
      margin-bottom: 15px;
    }

    .wiki-card-content h1,
    .wiki-card-content h2,
    .wiki-card-content h3,
    .wiki-card-content h4,
    .wiki-card-content h5,
    .wiki-card-content h6 {
      margin: 15px 0 10px 0;
      font-weight: 900;
      color: var(--brown);
    }

    .wiki-card-content p {
      margin: 10px 0;
    }

    .wiki-card-content ul,
    .wiki-card-content ol {
      margin: 10px 0;
      padding-left: 20px;
    }

    .wiki-card-content li {
      margin: 5px 0;
    }

    .wiki-card-content code {
      background: rgba(36, 34, 27, 0.1);
      padding: 2px 6px;
      border-radius: 3px;
      font-family: "IBM Plex Mono", monospace;
    }

    .wiki-card-content pre {
      background: rgba(36, 34, 27, 0.05);
      padding: 12px;
      border-radius: 5px;
      overflow-x: auto;
      margin: 10px 0;
    }

    .wiki-card-content pre code {
      background: none;
      padding: 0;
    }

    .wiki-card-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-top: 15px;
      border-top: 1px solid rgba(36, 34, 27, 0.2);
    }

    .wiki-card-path {
      font-size: 0.8rem;
      color: rgba(36, 34, 27, 0.6);
    }

    .wiki-loading {
      text-align: center;
      padding: 40px;
      font-size: 1.1rem;
      color: rgba(36, 34, 27, 0.7);
    }

    .wiki-error {
      background: #ffebee;
      border: 3px solid #c62828;
      color: #c62828;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .wiki-category {
      margin-bottom: 40px;
    }

    .wiki-category-title {
      font-size: 1.5rem;
      font-weight: 900;
      margin: 30px 0 20px 0;
      padding-bottom: 10px;
      border-bottom: 3px solid var(--brown);
      color: var(--brown);
    }
  </style>
</head>
<body>
  <div class="vertical-line left"></div>
  <div class="vertical-line right"></div>
  <header class="site-header">
    <h1 class="site-title">My Blog</h1>
    <a class="github-link" href="https://github.com/Sou1lah" target="_blank" rel="noopener noreferrer" aria-label="View GitHub profile">
      <svg width="28" height="28" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82A7.6 7.6 0 018 4.6c.68.003 1.36.092 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
      </svg>
    </a>
  </header>

  <main class="container">
    <div class="wiki-header">
      <h1>Wiki</h1>
      <a href="index.html" class="back-to-home">← Home</a>
    </div>

    <div id="wikiContainer" class="wiki-loading">Loading wiki...</div>
  </main>

  <footer class="site-footer container">
    <p>© 2026 My Blog</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const GITHUB_API = 'https://api.github.com/repos/Sou1lah/Personal-Blog/contents/wiki';
    const GITHUB_RAW = 'https://raw.githubusercontent.com/Sou1lah/Personal-Blog/main/wiki';

    // Small helpers used when rendering wiki card previews
    function isValidCssColor(value) {
      const s = new Option().style;
      s.color = '';
      s.color = value;
      return s.color !== '';
    }
    function cssColorToRgb(color) {
      const el = document.createElement('div');
      el.style.color = color;
      el.style.display = 'none';
      document.body.appendChild(el);
      const cs = getComputedStyle(el).color;
      document.body.removeChild(el);
      const m = cs.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
      return m ? `${m[1]}, ${m[2]}, ${m[3]}` : null;
    }

    async function fetchWikiFiles() {
      const container = document.getElementById('wikiContainer');
      
      try {
        // Fetch the wiki directory structure
        // Add cache-busting/no-store to API requests so directory listings reflect quick edits
        const response = await fetch(GITHUB_API + '?t=' + Date.now(), {
          headers: {
            'Accept': 'application/vnd.github.v3+json'
          },
          cache: 'no-store'
        });

        if (!response.ok) {
          throw new Error(`GitHub API error: ${response.status}`);
        }

        const files = await response.json();

        // Organize files by category (subdirectory)
        const categories = {};

        for (const item of files) {
          if (item.type === 'dir') {
            // Fetch subdirectory contents
            const subResponse = await fetch(`${GITHUB_API}/${item.name}?t=${Date.now()}`, {
              headers: {
                'Accept': 'application/vnd.github.v3+json'
              },
              cache: 'no-store'
            });
            
            if (subResponse.ok) {
              const subFiles = await subResponse.json();
              categories[item.name] = subFiles.filter(f => f.name.endsWith('.md'));
            }
          } else if (item.name.endsWith('.md')) {
            // Root level markdown files
            if (!categories['Root']) {
              categories['Root'] = [];
            }
            categories['Root'].push(item);
          }
        }

        if (Object.keys(categories).length === 0) {
          container.innerHTML = '<p class="wiki-loading">No wiki files found. Start adding markdown files to the wiki/ folder.</p>';
          return;
        }

        // Render categories and files
        let html = '';
        for (const [category, items] of Object.entries(categories)) {
          if (items.length === 0) continue;

          if (category !== 'Root') {
            html += `<div class="wiki-category"><h2 class="wiki-category-title">${category}</h2>`;
          }

          for (const file of items) {
            const title = file.name.replace('.md', '').replace(/_/g, ' ');
            const path = category === 'Root' ? `wiki/${file.name}` : `wiki/${category}/${file.name}`;
            const rawUrl = `${GITHUB_RAW}/${path}`;

            html += `
              <div class="wiki-card">
                <h3 class="wiki-card-title">${title}</h3>
                <div class="wiki-card-content" data-raw-url="${rawUrl}"></div>
                <div class="wiki-card-footer">
                  <p class="wiki-card-path">${path}</p>
                  <a href="${rawUrl}" target="_blank" rel="noopener noreferrer" style="padding: 8px 16px; background: var(--brown); color: var(--cream); text-decoration: none; border-radius: 50px; border: 3px solid var(--brown); font-weight: 700; font-size: 14px; transition: all 0.2s ease;">View</a>
                </div>
              </div>
            `;
          }

          if (category !== 'Root') {
            html += '</div>';
          }
        }

        container.innerHTML = html;

        // Fetch and render markdown content for each card (honor note frontmatter like `color`)
        const contentElements = container.querySelectorAll('.wiki-card-content');
        for (const element of contentElements) {
          const rawUrl = element.getAttribute('data-raw-url');
          try {
            // Cache-bust so updated frontmatter is fetched immediately
            const response = await fetch(rawUrl + '?t=' + Date.now(), { cache: 'no-store' });
            if (response.ok) {
              let markdown = await response.text();

              // Extract frontmatter color and text if present and remove frontmatter from content
              let noteColor = null;
              let noteText = null;
              const fmMatch = markdown.match(/^---\n([\s\S]*?)\n---\n/);
              if (fmMatch) {
                const fmText = fmMatch[1];
                const colorMatch = fmText.match(/color\s*:\s*(.+)/i);
                if (colorMatch) {
                  noteColor = colorMatch[1].trim().replace(/^['\"]|['\"]$/g, '').toLowerCase();
                  if (noteColor === 'default') noteColor = 'brown';
                }
                const textMatch = fmText.match(/text\s*:\s*(.+)/i);
                if (textMatch) {
                  noteText = textMatch[1].trim().replace(/^['\"]|['\"]$/g, '').toLowerCase();
                }
                // strip frontmatter for rendering
                markdown = markdown.replace(/^---\n([\s\S]*?)\n---\n/, '');
              }

              element.innerHTML = marked.parse(markdown);

              // If the original markdown includes raw HTML that got escaped, restore it so block HTML renders
              if (/<\s*\/?\w+[^>]*>/m.test(markdown)) {
                element.innerHTML = element.innerHTML.replace(/&lt;([a-zA-Z\/][^&]*)&gt;/g, '<$1>');
              }

              // Compute accent color from theme name or hex, and apply to this card content
              if (noteColor) {
                const themeMap = { brown: '#8B4513', blue: '#3b82f6', red: '#ef4444', green: '#22c55e', sky: '#06b6d4', purple: '#a855f7', pink: '#ec4899', orange: '#f97316', yellow: '#eab308', teal: '#14b8a6' };
                let accent = null;
                if (themeMap[noteColor]) accent = themeMap[noteColor];
                else if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(noteColor)) accent = noteColor;

                if (accent) {
                  element.style.setProperty('--note-accent', accent);
                  // also color the card title for clearer signal
                  const titleEl = element.closest('.wiki-card')?.querySelector('.wiki-card-title');
                  if (titleEl) titleEl.style.color = accent;
                } else {
                  // If it's a theme name but not in our map, set the attribute on the card to allow CSS theme blocks to apply
                  element.closest('.wiki-card')?.setAttribute('data-theme', noteColor);
                }

                // Honor explicit `text:` frontmatter for wiki previews (e.g., `text: white`)
                if (noteText) {
                  const card = element.closest('.wiki-card');
                  let mappedText = null;
                  if (themeMap[noteText]) mappedText = themeMap[noteText];
                  else if (/^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(noteText)) mappedText = noteText;
                  else if (isValidCssColor(noteText)) mappedText = noteText;

                  if (mappedText) {
                    element.style.color = mappedText;
                    if (card) card.style.color = mappedText;
                    const titleEl = card?.querySelector('.wiki-card-title');
                    if (titleEl) titleEl.style.color = mappedText;
                  }

                  // Special-case: author requested white text on a black color — preview the dark theme so white text is visible
                  if (noteText === 'white' && (noteColor === 'black' || noteColor === '#000' || noteColor === '#000000')) {
                    if (card) {
                      card.style.background = '#000000';
                      card.style.borderColor = '#111111';
                      card.style.color = '#FFFFFF';
                      element.style.color = '#FFFFFF';
                      const titleEl = card.querySelector('.wiki-card-title');
                      if (titleEl) titleEl.style.color = '#FFFFFF';
                    }
                  }
                }
              }
            }
          } catch (error) {
            console.error(`Error fetching content from ${rawUrl}:`, error);
            element.innerHTML = '<p>Error loading content</p>';
          }
        }
      } catch (error) {
        console.error('Error fetching wiki:', error);
        container.innerHTML = `
          <div class="wiki-error">
            <strong>Error loading wiki:</strong> ${error.message}
            <p>Make sure the repository is public and the wiki/ folder exists on GitHub.</p>
          </div>
        `;
      }
    }

    // Fetch wiki files on page load
    fetchWikiFiles();
  </script>
</body>
</html>
